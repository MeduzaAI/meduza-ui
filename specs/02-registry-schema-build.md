# 02 - Registry Schema & Build System

## Overview
Create the registry schema for Vue + SCSS components and implement a build system that generates static JSON files in `public/r/` to serve the CLI's init and add commands.

## Goals
- Define registry schema adapted for Vue.js + SCSS
- Create base components that init command needs
- Build system to generate registry JSON files
- Serve static registry endpoints

## ⚠️ IMPORTANT: Development Workflow

**DO NOT write JSON files manually!** 

### Correct Workflow:
1. **Write source files**: Create actual `.ts`, `.vue`, and `.scss` files in `apps/v1/registry/`
2. **Run build script**: Execute `pnpm build:registry` to generate JSON files
3. **JSON files are auto-generated**: The build script reads your source files and creates JSON in `public/r/`

### What Developers Should Do:
- ✅ Write TypeScript/Vue/SCSS files in `registry/` directory
- ✅ Run the build script to generate registry
- ❌ Never manually write JSON files shown in this spec

The JSON examples below are **reference only** - they show what the build script generates from your source files.

## Registry Schema

### Core Schema (adapted from shadcn)
```typescript
// apps/v1/lib/registry-schema.ts
import { z } from "zod"

export const registryItemTypeSchema = z.enum([
  "registry:lib",
  "registry:ui", 
  "registry:style",
  "registry:theme",
  "registry:example"
])

export const registryItemFileSchema = z.object({
  path: z.string(),
  content: z.string(),
  type: registryItemTypeSchema,
  target: z.string().optional()
})

// SCSS-specific schema
export const registryItemScssSchema = z.object({
  variables: z.record(z.string(), z.string()).optional(),
  mixins: z.array(z.string()).optional(),
  imports: z.array(z.string()).optional()
})

// CSS custom properties for Vue theming
export const registryItemCssVarsSchema = z.object({
  light: z.record(z.string(), z.string()).optional(),
  dark: z.record(z.string(), z.string()).optional()
})

export const registryItemSchema = z.object({
  $schema: z.string().optional(),
  name: z.string(),
  type: registryItemTypeSchema,
  description: z.string().optional(),
  dependencies: z.array(z.string()).optional(),
  devDependencies: z.array(z.string()).optional(),
  registryDependencies: z.array(z.string()).optional(),
  files: z.array(registryItemFileSchema).optional(),
  scss: registryItemScssSchema.optional(),
  cssVars: registryItemCssVarsSchema.optional(),
  meta: z.record(z.string(), z.any()).optional()
})

export const stylesSchema = z.array(
  z.object({
    name: z.string(),
    label: z.string()
  })
)

export const registryBaseColorSchema = z.object({
  cssVars: registryItemCssVarsSchema,
  scssVars: z.record(z.string(), z.string())
})
```

## Required Registry Endpoints

**⚠️ IMPORTANT: These JSON files are automatically generated by the build script from your source files. DO NOT create these manually!**

### 1. `/r/styles/index.json` - Available Styles (AUTO-GENERATED)
```json
[
  {
    "name": "default", 
    "label": "Default"
  },
  {
    "name": "minimal",
    "label": "Minimal"  
  }
]
```

### 2. `/r/colors/index.json` - Base Color Options (AUTO-GENERATED)
```json
[
  {
    "name": "slate",
    "label": "Slate"
  },
  {
    "name": "gray", 
    "label": "Gray"
  },
  {
    "name": "neutral",
    "label": "Neutral"
  }
]
```

### 3. `/r/styles/default/index.json` - Base Style System (AUTO-GENERATED)
```json
{
  "$schema": "https://meduza-ui.com/schema/registry-item.json",
  "name": "index",
  "type": "registry:style",
  "description": "Base style system with SCSS variables and mixins",
  "dependencies": [
    "@vueuse/core"
  ],
  "registryDependencies": [
    "utils"
  ],
  "files": [
    {
      "path": "styles/_variables.scss",
      "content": "// Base SCSS variables\n$primary: hsl(210, 40%, 20%);\n$primary-foreground: hsl(210, 40%, 98%);\n$secondary: hsl(210, 40%, 96%);\n$secondary-foreground: hsl(210, 40%, 11%);\n$border-radius: 0.5rem;\n$font-size-sm: 0.875rem;",
      "type": "registry:style",
      "target": "assets/styles/_variables.scss"
    },
    {
      "path": "styles/_mixins.scss", 
      "content": "// Component mixins\n@mixin button-base {\n  display: inline-flex;\n  align-items: center;\n  justify-content: center;\n  border-radius: $border-radius;\n  font-size: $font-size-sm;\n  font-weight: 500;\n  transition: all 0.2s ease;\n  cursor: pointer;\n  border: none;\n  \n  &:disabled {\n    opacity: 0.5;\n    cursor: not-allowed;\n  }\n}\n\n@mixin button-variant($bg-color, $text-color) {\n  background-color: $bg-color;\n  color: $text-color;\n  \n  &:hover:not(:disabled) {\n    background-color: darken($bg-color, 5%);\n  }\n}",
      "type": "registry:style",
      "target": "assets/styles/_mixins.scss"
    }
  ],
  "cssVars": {
    "light": {
      "primary": "210 40% 20%",
      "primary-foreground": "210 40% 98%",
      "secondary": "210 40% 96%", 
      "secondary-foreground": "210 40% 11%"
    },
    "dark": {
      "primary": "210 40% 98%",
      "primary-foreground": "210 40% 9%",
      "secondary": "210 40% 14%",
      "secondary-foreground": "210 40% 98%"
    }
  },
  "scss": {
    "variables": {
      "$primary": "hsl(var(--primary))",
      "$primary-foreground": "hsl(var(--primary-foreground))",
      "$secondary": "hsl(var(--secondary))",
      "$secondary-foreground": "hsl(var(--secondary-foreground))"
    },
    "imports": ["_variables.scss", "_mixins.scss"]
  }
}
```

### 4. `/r/styles/default/utils.json` - useClassName Utility (AUTO-GENERATED)
```json
{
  "$schema": "https://meduza-ui.com/schema/registry-item.json",
  "name": "utils",
  "type": "registry:lib",
  "description": "BEM-style className utility for Vue components",
  "dependencies": [],
  "files": [
    {
      "path": "lib/utils.ts",
      "content": "// BEM-style className utility for Vue components\ntype ClassValue = string | number | boolean | undefined | null | { [key: string]: boolean } | ClassValue[];\n\ninterface UseClassNameOptions {\n  prefix?: string;\n}\n\nclass BEMBuilder {\n  constructor(\n    private block: string,\n    private element?: string,\n    private prefix?: string\n  ) {}\n\n  private buildClass(modifiers?: ClassValue[]): string {\n    const base = this.prefix \n      ? `${this.prefix}-${this.block}${this.element ? `__${this.element}` : ''}`\n      : `${this.block}${this.element ? `__${this.element}` : ''}`;\n    \n    if (!modifiers) return base;\n    \n    const classes = [base];\n    \n    modifiers.forEach(modifier => {\n      if (typeof modifier === 'string') {\n        classes.push(`${base}--${modifier}`);\n      } else if (typeof modifier === 'object' && modifier !== null) {\n        Object.entries(modifier).forEach(([key, value]) => {\n          if (value) {\n            classes.push(`${base}--${key}`);\n          }\n        });\n      }\n    });\n    \n    return classes.join(' ');\n  }\n\n  b(modifiers?: ClassValue[]): string {\n    return this.buildClass(modifiers);\n  }\n\n  e(element: string): BEMBuilder {\n    return new BEMBuilder(this.block, element, this.prefix);\n  }\n\n  m(modifiers: ClassValue[]): string {\n    return this.buildClass(Array.isArray(modifiers) ? modifiers : [modifiers]);\n  }\n}\n\nexport function useClassName(block: string, options?: UseClassNameOptions): BEMBuilder {\n  return new BEMBuilder(block, undefined, options?.prefix);\n}",
      "type": "registry:lib",
      "target": "lib/utils.ts"
    }
  ]
}
```

### 5. `/r/colors/slate.json` - Base Color Definition
```json
{
  "cssVars": {
    "light": {
      "primary": "210 40% 20%",
      "primary-foreground": "210 40% 98%",
      "secondary": "210 40% 96%",
      "secondary-foreground": "210 40% 11%",
      "muted": "210 40% 96%",
      "muted-foreground": "215 16% 47%",
      "border": "210 40% 89%",
      "input": "210 40% 89%"
    },
    "dark": {
      "primary": "210 40% 98%", 
      "primary-foreground": "210 40% 9%",
      "secondary": "210 40% 14%",
      "secondary-foreground": "210 40% 98%",
      "muted": "210 40% 14%",
      "muted-foreground": "215 16% 65%",
      "border": "210 40% 27%",
      "input": "210 40% 27%"
    }
  },
  "scssVars": {
    "$slate-50": "#f8fafc",
    "$slate-100": "#f1f5f9", 
    "$slate-200": "#e2e8f0",
    "$slate-300": "#cbd5e1",
    "$slate-400": "#94a3b8",
    "$slate-500": "#64748b",
    "$slate-600": "#475569",
    "$slate-700": "#334155",
    "$slate-800": "#1e293b",
    "$slate-900": "#0f172a"
  }
}
```

## Source Files That Developers Create

**IMPORTANT**: Write these actual TypeScript/Vue/SCSS files. The build script converts them to JSON automatically.

### Registry Source Directory (`apps/v1/registry/`)
```
registry/
├── default/
│   ├── lib/
│   │   ├── utils.ts            # ✅ WRITE THIS: useClassName utility
│   │   └── index.ts            # ✅ WRITE THIS: Base styles & CSS vars  
│   └── ui/
│       └── (components will be added in next specs)
└── styles/
    ├── _variables.scss         # ✅ WRITE THIS: Base SCSS variables
    ├── _mixins.scss           # ✅ WRITE THIS: SCSS mixins
    └── index.scss             # ✅ WRITE THIS: Main SCSS entry
```

### Workflow:
1. **Developer writes**: The actual `.ts`, `.vue`, `.scss` files shown above
2. **Build script reads**: These source files and extracts content/metadata
3. **Build script generates**: JSON files in `public/r/` for the CLI to consume

### useClassName Utility

The `useClassName` utility generates BEM-style class names for Vue components:

**Basic Usage:**
```typescript
// In a Vue component
import { useClassName } from '@/lib/utils';

const cn = useClassName('button');

// Generate classes
cn.b(); // 'button'
cn.e('text'); // 'button__text'
cn.m(['primary']); // 'button button--primary'
cn.e('text').m(['bold']); // 'button__text button__text--bold'
```

**Advanced Usage:**
```typescript
// With conditional modifiers
cn.b(['primary', { active: isActive, disabled: isDisabled }]);
// Result: 'button button--primary button--active' (if isActive is true)

// With custom prefix (from config)
const cn = useClassName('button', { prefix: 'ui' });
cn.b(); // 'ui-button'
```

This utility will be automatically installed into the user's workspace at `@/lib/utils.ts` when the `init` command is executed.


## Build Script

### Registry Builder (`apps/v1/scripts/build-registry.ts`)
```typescript
import { promises as fs } from 'fs'
import path from 'path'
import { fileURLToPath } from 'url'
import { registryItemSchema, stylesSchema } from '@/lib/registry-schema'

const __dirname = path.dirname(fileURLToPath(import.meta.url))
const componentsDir = path.resolve(__dirname, '../components')
const registryDir = path.resolve(__dirname, '../public/r')

async function buildRegistryItem(componentPath: string) {
  const content = await fs.readFile(componentPath, 'utf-8')
  const name = path.basename(componentPath, '.vue')
  
  // Extract component metadata and create registry item
  const registryItem = {
    $schema: "https://meduza-ui.com/schema/registry-item.json",
    name: name.toLowerCase(),
    type: "registry:ui",
    files: [
      {
        path: `ui/${name}.vue`,
        content,
        type: "registry:ui",
        target: `components/ui/${name}.vue`
      }
    ]
  }
  
  return registryItemSchema.parse(registryItem)
}

async function buildStyles() {
  const styles = [
    { name: "default", label: "Default" },
    { name: "minimal", label: "Minimal" }
  ]
  
  await fs.writeFile(
    path.join(registryDir, 'styles/index.json'),
    JSON.stringify(styles, null, 2)
  )
  
  return stylesSchema.parse(styles)
}

async function buildBaseColors() {
  const colors = [
    { name: "slate", label: "Slate" },
    { name: "gray", label: "Gray" },
    { name: "neutral", label: "Neutral" }
  ]
  
  await fs.writeFile(
    path.join(registryDir, 'colors/index.json'),
    JSON.stringify(colors, null, 2)
  )
}

async function main() {
  // Ensure directories exist
  await fs.mkdir(path.join(registryDir, 'styles/default'), { recursive: true })
  await fs.mkdir(path.join(registryDir, 'colors'), { recursive: true })
  
  console.log('Building registry...')
  
  // Build styles index
  await buildStyles()
  console.log('✓ Built styles index')
  
  // Build colors index  
  await buildBaseColors()
  console.log('✓ Built colors index')
  
  // Build base style system (index)
  const indexItem = {
    // ... index.json content from above
  }
  await fs.writeFile(
    path.join(registryDir, 'styles/default/index.json'),
    JSON.stringify(indexItem, null, 2)
  )
  console.log('✓ Built index style')
  
  // Build utils
  const utilsItem = {
    // ... utils.json content from above  
  }
  await fs.writeFile(
    path.join(registryDir, 'styles/default/utils.json'),
    JSON.stringify(utilsItem, null, 2)
  )
  console.log('✓ Built utils')
  
  // Build UI components
  const uiComponents = await fs.readdir(path.join(componentsDir, 'ui'))
  for (const component of uiComponents) {
    if (component.endsWith('.vue')) {
      const registryItem = await buildRegistryItem(
        path.join(componentsDir, 'ui', component)
      )
      await fs.writeFile(
        path.join(registryDir, `styles/default/${registryItem.name}.json`),
        JSON.stringify(registryItem, null, 2)
      )
      console.log(`✓ Built ${registryItem.name} component`)
    }
  }
  
  console.log('Registry build complete!')
}

main().catch(console.error)
```

## Deliverables

1. **Registry schema** adapted for Vue.js + SCSS
2. **Base style system** with SCSS variables, mixins, and CSS custom properties
3. **Utility functions** for Vue projects
4. **Build script** that generates static JSON files
5. **Registry endpoints** at `/r/styles/`, `/r/colors/` etc.

## Testing

- [ ] Build script generates all required JSON files
- [ ] Registry endpoints are accessible at `/r/*`
- [ ] Schema validation passes for all generated files
- [ ] Base components include all dependencies for init
- [ ] SCSS variables and mixins are properly structured
- [ ] CSS custom properties work for theming

